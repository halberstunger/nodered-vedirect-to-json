[{"id":"69df9cf6.e028a4","type":"function","z":"3ef6f653.ebf9ca","name":"VE.Direct to JSON","func":"// name: VE.Direct to JSON\n// outputs: 1\n// inputs: 1 serial node, split input \"on the character\" \"\\n\"\n// and deliver \"binary buffers\"\n\nvar block = context.get('block') || \"{\";\nvar checksum = context.get('checksum') || 0;\n\nvar fieldBuffer = msg.payload;\nvar fieldLenght = fieldBuffer.length;\n\nvar field = fieldBuffer.toString();\nfield = field.replace(/\\r?\\n?/g, '');\nfield = field.split(\"\\t\");\n\n// Drop null fields\nif (field[0] === \"\") {\n//    node.warn(\"NULL field dropped!\");\n    return null;\n}\n\n// Remove HEX messages and add CR+LF for checksum\nif (field[0] == \"Checksum\" && field[1].length > 1) {\n    fieldLenght = 12;\n    fieldBuffer[10] = 0xd;\n    fieldBuffer[11] = 0xa;\n//    node.warn(\"HEX message stripped!\");\n}\n\nfor (var i = 0; i < fieldLenght; i++) {\n    checksum -= fieldBuffer[i];\n}\n\nchecksum = checksum & 0xff;\n\nif (field[0] == \"Checksum\") {\n\n    context.set('checksum', null);\n    context.set('block', null);\n\n    if (checksum === 0) {\n        block = block += \"}\";\n        msg.payload = JSON.parse(block);\n        return msg;\n    } else {\n        node.warn('Checksum failed!')\n        return null;\n    }\n}\n\nif (block.length > 1) {\n    block = block += \",\";\n}\n\nblock = block += \"\\\"\" + field[0] + \"\\\"\" + \":\";\n\n// PID value detected incorrectly as a number\nvar isANumber = isNaN(field[1]) === false;\nif (isANumber && field[0] != \"PID\") {\n    block = block += field[1];\n} else {\n    block = block += \"\\\"\" + field[1] + \"\\\"\";\n}\n\ncontext.set('checksum', checksum);\ncontext.set('block', block);\n","outputs":1,"noerr":0,"x":430,"y":260,"wires":[["c2e0a99d.f30fe8","2817dd28.454812"]]}]